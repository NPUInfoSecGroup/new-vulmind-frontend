import{C as v,d as w,p as y,u as S,c as m,o as M,b as u,g as k,w as b,h as C,e as n,F as T,k as x,j as h,t as f,_ as I}from"./index-DrCM2zKm.js";const g="http://localhost:3000",A=v("chat",{state:()=>({convs:[]}),getters:{getMessages:s=>a=>{const e=s.convs.find(t=>t.taskId===a);return e?e.messages:[]}},actions:{async sendMessage(s,a){try{const t=await(await fetch(`${g}/${s}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();this._appendMsg(s,t)}catch(e){console.error(e)}},async streamReceive(s,a){const e=await fetch(`${g}/${s}/stream`,{method:"GET",headers:{Accept:"text/plain"}});if(!e.body)return;const t=e.body.getReader(),i=new TextDecoder;for(;;){const{done:l,value:d}=await t.read();if(l)break;const r=i.decode(d,{stream:!0});for(const o of r){const c={role:"assistant",content:o,timestamp:new Date().toISOString()};this._appendMsg(s,c),a(c)}}},async fetchAllConversations(){try{const s=await fetch(`${g}/conversations`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const a=await s.json();this.convs=a}catch(s){console.error("拉取所有对话记录失败:",s)}},_appendMsg(s,a){let e=this.convs.find(t=>t.taskId===s);e||(e={taskId:s,messages:[]},this.convs.push(e)),e.messages.push(a)}}}),D={class:"scanner-box"},$={class:"message"},j=w({__name:"MessageView",setup(s){const e=y().params.taskID,t=A(),i=S(),l=m(()=>t.getMessages(e)),d=m(()=>i.getById(e));return M(async()=>{if(await t.fetchAllConversations(),t.getMessages(e).length===0){const r={role:"user",content:d.value.command,timestamp:new Date().toISOString()};await t.sendMessage(e,r),await t.streamReceive(e,o=>{console.log("assistant 回复:",o.content)})}}),(r,o)=>{const c=C("el-scrollbar");return h(),u("div",D,[k(c,{ref:"scrollbarRef",class:"chat-panel"},{default:b(()=>[n("div",$,[(h(!0),u(T,null,x(l.value,(p,_)=>(h(),u("div",{key:_},[n("p",null,[n("strong",null,f(p.role==="user"?"👤 你":p.role==="assistant"?"🤖 AI":"📢 系统")+"：",1)]),n("p",null,f(p.content),1),o[0]||(o[0]=n("hr",null,null,-1))]))),128))])]),_:1},512)])}}}),E=I(j,[["__scopeId","data-v-49aae277"]]);export{E as default};
