import{_ as G,c as S,r as n,o as W,D as Y,q as Z,b as o,e as s,m as x,z as L,l as R,I as H,F as T,k as C,t as I,J as Q,n as X,K as ee,L as te,M as ae,j as r,C as se}from"./index-BsF0IXvY.js";import{m as O,p as ne}from"./purify.es-CsY-PwS5.js";const le={class:"deepseek-container"},oe={key:0,class:"template-config-panel"},re={class:"select-row"},ce={key:0,class:"loading-templates"},ie=["value"],de={class:"select-row"},ue={key:0,class:"loading-templates"},ve=["value"],pe={class:"generate-report-btn-container"},me=["disabled"],fe=["disabled"],ge={class:"chat-panel"},_e={class:"messages-container"},ye=["innerHTML"],he={key:0,class:"typing-container-center"},be={class:"control-panel"},ke={class:"status-container"},we={__name:"ReportParse",setup(Se){const g=S(()=>v.value.filter(a=>a.role==="assistant")),M=S(()=>g.value.length>0),_=n([]),y=n(!1),i=n(null),d=n([]),h=n(!1),b=n(!1),u=n(null),m=n(null),P=n(!1),U=async()=>{try{y.value=!0;const e=Object.values(Object.assign({"/src/scan-template/default.json":ae,"/src/scan-template/tpl-001.json":te,"/src/scan-template/tpl-002.json":ee})).map(t=>{const{id:l,name:c,preview:f}=t.default||{};return{id:l,name:c,preview:f}}).filter(t=>t.id&&t.name&&t.preview);e.sort((t,l)=>l.id.localeCompare(t.id)),_.value=e,e.length>0&&(i.value=e[0].id)}catch(a){console.error("加载报告模板失败:",a)}finally{y.value=!1}},B=async()=>{try{h.value=!0;const a=await fetch("http://127.0.0.1:9000/tasks");if(!a.ok)throw new Error(`HTTP错误! 状态码: ${a.status}`);const e=await a.json();d.value=e.tasks||[],b.value=d.value.length>0,d.value.length>0&&(u.value=d.value[0].id,$())}catch(a){console.error("加载扫描记录失败:",a),b.value=!1}finally{h.value=!1}},N=a=>{const t={"scan --deep":"深度扫描","scan --fast":"快速扫描","scan --full":"全面扫描","scan --auth":"认证扫描",scan:"基础扫描"}[a.command]||"未知扫描";return`${a.name} (${t})`},$=()=>{m.value=d.value.find(a=>a.id===u.value)||null},V=async()=>{if(!i.value||!u.value){alert("请选择模板和扫描记录");return}P.value=!0;try{const a=_.value.find(t=>t.id===i.value);if(!a){alert("选择的模板不存在");return}if(!a.preview){alert("模板缺少预览内容");return}const e=`我将向你提供一段报告模板和扫描数据，请严格按以下要求生成报告：
  1. 生成一个完整的 Markdown 格式报告
  2. 直接返回 Markdown 内容，不要添加任何额外的说明或代码块标识符
  3. 确保内容使用标准的 Markdown 语法，不使用三重反引号包裹任何内容
  4. 不要包含 HTML 标签，使用纯 Markdown 语法

  报告模板内容如下：
  ${a.preview}

  扫描结果数据如下：
  ${JSON.stringify(m.value,null,2)}
  `;v.value.push({role:"user",content:e}),A.value=!0,k.value=!0,p.value="connecting";try{const t=await K(e);v.value.push({role:"assistant",content:t}),p.value="connected"}catch(t){console.error("API请求错误:",t),v.value.push({role:"assistant",content:`抱歉，生成报告时出错: ${t.message}`}),p.value="error"}finally{A.value=!1,k.value=!1}}catch(a){console.error("生成报告出错:",a),alert("生成报告时发生错误")}finally{P.value=!1}},D=()=>{if(!M.value){alert("请先生成报告");return}if(!m.value||!m.value.name){alert("未选择扫描记录，无法确定文件名");return}const a=g.value[g.value.length-1].content,e=new Blob([a],{type:"text/markdown"}),t=URL.createObjectURL(e),l=document.createElement("a");l.href=t;let c=m.value.name.trim();if(c=c.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s_\-()[\]]/g," ").replace(/\s+/g," ").trim(),!c){const f=new Date;c=`安全报告_${`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`}`}c.endsWith(".md")||(c+=".md"),l.download=c,document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),URL.revokeObjectURL(t)},100)};W(()=>{U(),B()});const z=a=>{if(!a)return"";O.setOptions({gfm:!0,breaks:!0,highlight:(t,l)=>`<pre><code class="hljs language-${l||"plaintext"}">${E(t)}</code></pre>`});const e=O.parse(a);return ne.sanitize(e)},E=a=>a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),q=()=>{se(()=>{const a=document.querySelector(".messages-container");a&&(a.scrollTop=a.scrollHeight)})},v=n([]),A=n(!1),k=n(!1),p=n("connected"),F=S(()=>({connected:"API连接正常",connecting:"正在连接API...",error:"API连接错误"})[p.value]),j=Y(),w=n(j.llmConfig.APIKey),J=n(j.llmConfig.APIBaseUrl);w.value||(console.error("API密钥为空:",w.value),alert("API密钥未配置，请在配置中设置"));const K=async a=>{const e=await fetch(J.value,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${w.value}`},body:JSON.stringify({model:"deepseek-chat",messages:[...v.value,{role:"user",content:a}],temperature:.7,max_tokens:2e3,stream:!1})});if(!e.ok)throw new Error(`API请求失败: ${e.status}`);return(await e.json()).choices[0].message.content};return Z(v,()=>{q()},{deep:!0,immediate:!0}),(a,e)=>(r(),o("div",le,[e[9]||(e[9]=s("header",{class:"app-header"},[s("div",{class:"header-content"},[s("h1",{class:"app-title"},"VulMind报告生成系统")])],-1)),_.value.length>0||y.value||b.value?(r(),o("div",oe,[s("div",re,[e[3]||(e[3]=s("div",{class:"select-label"},"报告模板：",-1)),y.value?(r(),o("div",ce,e[2]||(e[2]=[s("i",{class:"fas fa-spinner fa-spin"},null,-1),R(" 加载模板中... ")]))):L((r(),o("select",{key:1,"onUpdate:modelValue":e[0]||(e[0]=t=>i.value=t),class:"select-input"},[(r(!0),o(T,null,C(_.value,t=>(r(),o("option",{key:t.id,value:t.id},I(t.name),9,ie))),128))],512)),[[H,i.value]])]),s("div",de,[e[5]||(e[5]=s("div",{class:"select-label"},"扫描记录：",-1)),h.value?(r(),o("div",ue,e[4]||(e[4]=[s("i",{class:"fas fa-spinner fa-spin"},null,-1),R(" 加载扫描记录中... ")]))):L((r(),o("select",{key:1,"onUpdate:modelValue":e[1]||(e[1]=t=>u.value=t),class:"select-input",onChange:$},[(r(!0),o(T,null,C(d.value,t=>(r(),o("option",{key:t.id,value:t.id},I(N(t)),9,ve))),128))],544)),[[H,u.value]])]),s("div",pe,[s("button",{class:"generate-report-btn",onClick:V,disabled:!i.value||!u.value},e[6]||(e[6]=[s("i",{class:"fas fa-file-alt"},null,-1),s("span",{class:"btn-text"},"生成报告",-1),s("i",{class:"fas fa-magic btn-icon-magic"},null,-1)]),8,me),s("button",{class:"generate-report-btn save-report-btn",onClick:D,disabled:!M.value},e[7]||(e[7]=[s("i",{class:"fas fa-download"},null,-1),s("span",{class:"btn-text"},"保存报告",-1),s("i",{class:"fas fa-cloud-download-alt btn-icon-magic"},null,-1)]),8,fe)])])):x("",!0),s("div",ge,[s("div",_e,[(r(!0),o(T,null,C(g.value,(t,l)=>(r(),o("div",{key:l,class:"message ai-message-center"},[s("div",{class:"message-content",innerHTML:z(t.content)},null,8,ye)]))),128)),k.value?(r(),o("div",he,e[8]||(e[8]=[Q('<div class="typing-indicator" data-v-253d8d05><span class="typing-text" data-v-253d8d05>思考中</span><div class="typing-dots" data-v-253d8d05><div class="dot" data-v-253d8d05></div><div class="dot" data-v-253d8d05></div><div class="dot" data-v-253d8d05></div></div></div>',1)]))):x("",!0)])]),s("div",be,[s("div",ke,[s("div",{class:X(["status-indicator",p.value==="connecting"?"connecting":p.value==="error"?"error":""])},null,2),s("span",null,I(F.value),1)])])]))}},Me=G(we,[["__scopeId","data-v-253d8d05"]]);export{Me as default};
