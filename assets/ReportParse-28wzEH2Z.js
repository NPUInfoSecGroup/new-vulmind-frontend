import{_ as F,c as w,r as l,o as J,q as K,b as o,e as s,m as C,z as R,l as I,I as P,F as S,k as T,t as M,J as G,n as W,K as Y,L as Z,M as Q,j as r,C as X}from"./index-DhirsEcV.js";import{m as A,p as ee}from"./purify.es-CsY-PwS5.js";const te={class:"deepseek-container"},ae={key:0,class:"template-config-panel"},se={class:"select-row"},ne={key:0,class:"loading-templates"},le=["value"],oe={class:"select-row"},re={key:0,class:"loading-templates"},ce=["value"],ie={class:"generate-report-btn-container"},de=["disabled"],ue=["disabled"],pe={class:"chat-panel"},ve={class:"messages-container"},me=["innerHTML"],fe={key:0,class:"typing-container-center"},ge={class:"control-panel"},_e={class:"status-container"},he={__name:"ReportParse",setup(ye){const g=w(()=>p.value.filter(a=>a.role==="assistant")),$=w(()=>g.value.length>0),_=l([]),h=l(!1),i=l(null),d=l([]),y=l(!1),b=l(!1),u=l(null),m=l(null),j=l(!1),H=async()=>{try{h.value=!0;const e=Object.values(Object.assign({"/src/scan-template/default.json":Q,"/src/scan-template/tpl-001.json":Z,"/src/scan-template/tpl-002.json":Y})).map(t=>{const{id:n,name:c,preview:f}=t.default||{};return{id:n,name:c,preview:f}}).filter(t=>t.id&&t.name&&t.preview);e.sort((t,n)=>n.id.localeCompare(t.id)),_.value=e,e.length>0&&(i.value=e[0].id)}catch(a){console.error("加载报告模板失败:",a)}finally{h.value=!1}},O=async()=>{try{y.value=!0;const a=await fetch("http://127.0.0.1:9000/tasks");if(!a.ok)throw new Error(`HTTP错误! 状态码: ${a.status}`);const e=await a.json();d.value=e.tasks||[],b.value=d.value.length>0,d.value.length>0&&(u.value=d.value[0].id,x())}catch(a){console.error("加载扫描记录失败:",a),b.value=!1}finally{y.value=!1}},U=a=>{const t={"scan --deep":"深度扫描","scan --fast":"快速扫描","scan --full":"全面扫描","scan --auth":"认证扫描",scan:"基础扫描"}[a.command]||"未知扫描";return`${a.name} (${t})`},x=()=>{m.value=d.value.find(a=>a.id===u.value)||null},N=async()=>{if(!i.value||!u.value){alert("请选择模板和扫描记录");return}j.value=!0;try{const a=_.value.find(t=>t.id===i.value);if(!a){alert("选择的模板不存在");return}if(!a.preview){alert("模板缺少预览内容");return}const e=`我将向你提供一段报告模板和扫描数据，请严格按以下要求生成报告：
  1. 生成一个完整的 Markdown 格式报告
  2. 直接返回 Markdown 内容，不要添加任何额外的说明或代码块标识符
  3. 确保内容使用标准的 Markdown 语法，不使用三重反引号包裹任何内容
  4. 不要包含 HTML 标签，使用纯 Markdown 语法

  报告模板内容如下：
  ${a.preview}

  扫描结果数据如下：
  ${JSON.stringify(m.value,null,2)}
  `;p.value.push({role:"user",content:e}),L.value=!0,k.value=!0,v.value="connecting";try{const t=await q(e);p.value.push({role:"assistant",content:t}),v.value="connected"}catch(t){console.error("API请求错误:",t),p.value.push({role:"assistant",content:`抱歉，生成报告时出错: ${t.message}`}),v.value="error"}finally{L.value=!1,k.value=!1}}catch(a){console.error("生成报告出错:",a),alert("生成报告时发生错误")}finally{j.value=!1}},V=()=>{if(!$.value){alert("请先生成报告");return}if(!m.value||!m.value.name){alert("未选择扫描记录，无法确定文件名");return}const a=g.value[g.value.length-1].content,e=new Blob([a],{type:"text/markdown"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t;let c=m.value.name.trim();if(c=c.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s_\-()[\]]/g," ").replace(/\s+/g," ").trim(),!c){const f=new Date;c=`安全报告_${`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`}`}c.endsWith(".md")||(c+=".md"),n.download=c,document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n),URL.revokeObjectURL(t)},100)};J(()=>{H(),O()});const B=a=>{if(!a)return"";A.setOptions({gfm:!0,breaks:!0,highlight:(t,n)=>`<pre><code class="hljs language-${n||"plaintext"}">${z(t)}</code></pre>`});const e=A.parse(a);return ee.sanitize(e)},z=a=>a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),D=()=>{X(()=>{const a=document.querySelector(".messages-container");a&&(a.scrollTop=a.scrollHeight)})},p=l([]),L=l(!1),k=l(!1),v=l("connected"),E=w(()=>({connected:"API连接正常",connecting:"正在连接API...",error:"API连接错误"})[v.value]),q=async a=>{const n=await fetch("https://api.deepseek.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer sk-cc8300aca20d492f8d4726bf1510bb84"},body:JSON.stringify({model:"deepseek-chat",messages:[...p.value,{role:"user",content:a}],temperature:.7,max_tokens:2e3,stream:!1})});if(!n.ok)throw new Error(`API请求失败: ${n.status}`);return(await n.json()).choices[0].message.content};return K(p,()=>{D()},{deep:!0,immediate:!0}),(a,e)=>(r(),o("div",te,[e[9]||(e[9]=s("header",{class:"app-header"},[s("div",{class:"header-content"},[s("h1",{class:"app-title"},"VulMind报告生成系统")])],-1)),_.value.length>0||h.value||b.value?(r(),o("div",ae,[s("div",se,[e[3]||(e[3]=s("div",{class:"select-label"},"报告模板：",-1)),h.value?(r(),o("div",ne,e[2]||(e[2]=[s("i",{class:"fas fa-spinner fa-spin"},null,-1),I(" 加载模板中... ")]))):R((r(),o("select",{key:1,"onUpdate:modelValue":e[0]||(e[0]=t=>i.value=t),class:"select-input"},[(r(!0),o(S,null,T(_.value,t=>(r(),o("option",{key:t.id,value:t.id},M(t.name),9,le))),128))],512)),[[P,i.value]])]),s("div",oe,[e[5]||(e[5]=s("div",{class:"select-label"},"扫描记录：",-1)),y.value?(r(),o("div",re,e[4]||(e[4]=[s("i",{class:"fas fa-spinner fa-spin"},null,-1),I(" 加载扫描记录中... ")]))):R((r(),o("select",{key:1,"onUpdate:modelValue":e[1]||(e[1]=t=>u.value=t),class:"select-input",onChange:x},[(r(!0),o(S,null,T(d.value,t=>(r(),o("option",{key:t.id,value:t.id},M(U(t)),9,ce))),128))],544)),[[P,u.value]])]),s("div",ie,[s("button",{class:"generate-report-btn",onClick:N,disabled:!i.value||!u.value},e[6]||(e[6]=[s("i",{class:"fas fa-file-alt"},null,-1),s("span",{class:"btn-text"},"生成报告",-1),s("i",{class:"fas fa-magic btn-icon-magic"},null,-1)]),8,de),s("button",{class:"generate-report-btn save-report-btn",onClick:V,disabled:!$.value},e[7]||(e[7]=[s("i",{class:"fas fa-download"},null,-1),s("span",{class:"btn-text"},"保存报告",-1),s("i",{class:"fas fa-cloud-download-alt btn-icon-magic"},null,-1)]),8,ue)])])):C("",!0),s("div",pe,[s("div",ve,[(r(!0),o(S,null,T(g.value,(t,n)=>(r(),o("div",{key:n,class:"message ai-message-center"},[s("div",{class:"message-content",innerHTML:B(t.content)},null,8,me)]))),128)),k.value?(r(),o("div",fe,e[8]||(e[8]=[G('<div class="typing-indicator" data-v-5c886f59><span class="typing-text" data-v-5c886f59>思考中</span><div class="typing-dots" data-v-5c886f59><div class="dot" data-v-5c886f59></div><div class="dot" data-v-5c886f59></div><div class="dot" data-v-5c886f59></div></div></div>',1)]))):C("",!0)])]),s("div",ge,[s("div",_e,[s("div",{class:W(["status-indicator",v.value==="connecting"?"connecting":v.value==="error"?"error":""])},null,2),s("span",null,M(E.value),1)])])]))}},Se=F(he,[["__scopeId","data-v-5c886f59"]]);export{Se as default};
